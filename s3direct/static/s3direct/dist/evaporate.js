!function(){var t={};!function(){var e,o,r,s=new Date("2060-10-22"),i=2,n=4,a=5,p=10,u=20,d=30,l=[n,d],h=[0,i,p],c=12e4,f=["maxConcurrentParts","logging","cloudfront","encodeFilename","computeContentMd5","allowS3ExistenceOptimization","onlyRetryForSameFileName","timeUrl","cryptoMd5Method","cryptoHexEncodedHash256","awsRegion","awsSignatureVersion","evaporateChanged"],m={33:"%21",39:"%27",40:"%28",41:"%29",42:"%2A"},y=function(t){if(this.config=R({readableStreams:!1,readableStreamPartMethod:null,bucket:null,logging:!0,maxConcurrentParts:5,partSize:6291456,retryBackoffPower:2,maxRetryBackoffSecs:300,progressIntervalMS:1e3,cloudfront:!1,s3Acceleration:!1,mockLocalStorage:!1,encodeFilename:!0,computeContentMd5:!1,allowS3ExistenceOptimization:!1,onlyRetryForSameFileName:!1,timeUrl:null,cryptoMd5Method:null,cryptoHexEncodedHash256:null,aws_key:null,awsRegion:"us-east-1",awsSignatureVersion:"4",sendCanonicalRequestToSignerUrl:!1,s3FileCacheHoursAgo:null,signParams:{},signHeaders:{},customAuthMethod:void 0,maxFileSize:null,signResponseHandler:null,xhrWithCredentials:!1,localTimeOffset:void 0,evaporateChanged:function(){},abortCompletionThrottlingMs:1e3},t),"undefined"!=typeof window&&window.console&&((o=window.console).d=o.log,o.w=window.console.warn?o.warn:o.d,o.e=window.console.error?o.error:o.d),this._instantiationError=this.validateEvaporateOptions(),"string"!=typeof this._instantiationError){delete this._instantiationError,this.config.logging||(o={d:function(){},w:function(){},e:function(){}});var s=new Date;if(e=new Date(s.setHours(s.getHours()-(this.config.s3FileCacheHoursAgo||-100))),"number"==typeof t.localTimeOffset)this.localTimeOffset=t.localTimeOffset;else{var i=this;y.getLocalTimeOffset(this.config).then((function(t){i.localTimeOffset=t}))}this.pendingFiles={},this.queuedFiles=[],this.filesInProcess=[],r=new E(this.config.mockLocalStorage)}else this.supported=!1};function g(t,e,o){this.fileTotalBytesUploaded=0,this.s3Parts=[],this.partsOnS3=[],this.partsInProcess=[],this.partsToUpload=[],this.numParts=-1,this.con=R({},e),this.evaporate=o,this.localTimeOffset=o.localTimeOffset,this.deferredCompletion=F(),R(this,t),this.id=decodeURIComponent(this.name),this.signParams=e.signParams}function v(t,e){this.fileUpload=t,this.con=t.con,this.attempts=1,this.localTimeOffset=this.fileUpload.localTimeOffset,this.awsDeferred=F(),this.started=F(),this.awsUrl=function(t){var e;t.aws_url?e=[t.aws_url]:(t.s3Acceleration?(e=["https://",t.bucket,".s3-accelerate"],t.cloudfront=!0):(e=["https://",t.cloudfront?t.bucket+".":"","s3"],"us-east-1"!==t.awsRegion&&e.push("-",t.awsRegion)),e.push(".amazonaws.com"));return e.join("")}(this.con),this.awsHost=C(this.awsUrl).hostname;var o=R({},e);t.contentType&&(o.contentType=t.contentType),this.updateRequest(o)}function S(t,e){v.call(this,t,e)}function P(t,e,o){o>-1&&(this.maxRetries=o),v.call(this,t,e)}function w(t,e){var o={method:"POST",path:"?uploads",step:"initiate",x_amz_headers:t.xAmzHeadersAtInitiate,not_signed_headers:t.notSignedHeadersAtInitiate,response_match:"<UploadId>(.+)</UploadId>"};S.call(this,t,o),this.awsKey=e}function b(t){t.info("will attempt to complete upload");var e={method:"POST",contentType:"application/xml; charset=UTF-8",path:"?uploadId="+t.uploadId,x_amz_headers:t.xAmzHeadersCommon||t.xAmzHeadersAtComplete,step:"complete"};S.call(this,t,e)}function U(t,e){this.awsKey=e,t.info("will attempt to verify existence of the file");var o={method:"HEAD",path:"",x_amz_headers:t.xAmzHeadersCommon,success404:!0,step:"head_object"};P.call(this,t,o)}function T(t){P.call(this,t),this.updateRequest(this.setupRequest(0))}function q(t,e){this.part=e,this.partNumber=e.partNumber,this.start=(this.partNumber-1)*t.con.partSize,this.end=Math.min(this.partNumber*t.con.partSize,t.sizeBytes);var o={method:"PUT",path:"?partNumber="+this.partNumber+"&uploadId="+t.uploadId,step:"upload #"+this.partNumber,x_amz_headers:t.xAmzHeadersCommon||t.xAmzHeadersAtUpload,contentSha256:"UNSIGNED-PAYLOAD",onProgress:this.onProgress.bind(this)};v.call(this,t,o)}function x(t){t.info("will attempt to abort the upload"),t.abortParts();var e={method:"DELETE",path:"?uploadId="+t.uploadId,x_amz_headers:t.xAmzHeadersCommon,success404:!0,step:"abort"};v.call(this,t,e)}function C(t){var e,o=t||"/";try{e=new URL(o)}catch(t){(e=document.createElement("a")).href=o}return{protocol:e.protocol,hostname:e.hostname,pathname:e.pathname.replace(/(^\/?)/,"/"),port:e.port,search:"?"===e.search[0]?e.search.substr(1):e.search,hash:e.hash,host:e.host}}function O(t){return t?new Date(t).toISOString():""}function I(t){var e=_(t.responseText,"Code"),o=_(t.responseText,"Message");return e.length?["AWS Code: ",e,", Message:",o].join(""):""}function _(t,e){var o=t.match(["<",e,">(.+)</",e,">"].join(""));return o?o[1]:""}function F(){var t,e={};return t=new Promise((function(t,o){e={resolve:t,reject:o}})),{resolve:e.resolve,reject:e.reject,promise:t}}function R(t,e,o){function r(t,e){if("object"==typeof e)for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])}return t=t||{},r(e=e||{},o=o||{}),r(t,e),t}function z(t){var o=JSON.parse(r.getItem("awsUploads")||"{}");if(t){for(var i in o)if(o.hasOwnProperty(i)){var n=o[i];new Date(n.completedAt||s)<e&&delete o[i]}r.setItem("awsUploads",JSON.stringify(o))}return o}function M(t){return[t.file.name,t.file.type,O(t.file.lastModified),t.sizeBytes].join("-")}function j(t,e){var o=z();o[t]=e,r.setItem("awsUploads",JSON.stringify(o))}function H(t,e){var o=t.indexOf(e);if(o>-1)return t.splice(o,1),!0}function A(t){for(var e=0;t>=1024;)t/=1024,++e;return[t.toFixed(2).replace(".00",""),["B","Kb","Mb","Gb","Tb","Pb","Eb","Zb","Yb"][e]].join(" ")}function E(t){var e=E.supported();this.cacheStore=t?{}:e?localStorage:void 0}y.create=function(t){var e=R({},t);return y.getLocalTimeOffset(e).then((function(t){return e.localTimeOffset=t,new Promise((function(t,o){var r=new y(e);!0===r.supported?t(r):o(r._instantiationError)}))}))},y.getLocalTimeOffset=function(t){return new Promise((function(e,r){if("number"==typeof t.localTimeOffset)return e(t.localTimeOffset);if(t.timeUrl){var s=new XMLHttpRequest;s.open("GET",t.timeUrl+"?requestTime="+(new Date).getTime()),s.onreadystatechange=function(){if(4===s.readyState&&200===s.status){var t=new Date(Date.parse(s.responseText))-new Date;o.d("localTimeOffset is",t,"ms"),e(t)}},s.onerror=function(t){o.e("xhr error timeUrl",t),r("Fetching offset time failed with status: "+t.status)},s.send()}else e(0)}))},y.prototype.config={},y.prototype.localTimeOffset=0,y.prototype.supported=!1,y.prototype._instantiationError=void 0,y.prototype.evaporatingCount=0,y.prototype.pendingFiles={},y.prototype.filesInProcess=[],y.prototype.queuedFiles=[],y.prototype.startNextFile=function(t){if(this.queuedFiles.length&&!(this.evaporatingCount>=this.config.maxConcurrentParts)){var e=this.queuedFiles.shift();0===e.status?(o.d("Starting",decodeURIComponent(e.name),"reason:",t),this.evaporatingCnt(1),e.start()):(o.d("Requeued",decodeURIComponent(e.name),"status:",e.status,"reason:",t),this.queuedFiles.push(e))}},y.prototype.fileCleanup=function(t){H(this.queuedFiles,t),H(this.filesInProcess,t)&&this.evaporatingCnt(-1),t.done(),this.consumeRemainingSlots()},y.prototype.queueFile=function(t){this.filesInProcess.push(t),this.queuedFiles.push(t),1===this.filesInProcess.length&&this.startNextFile("first file")},y.prototype.add=function(t,e){var o,r=this;return new Promise((function(s,i){var n,a,p,u=R(e,{});if(f.forEach((function(t){delete u[t]})),o=R(r.config,u),void 0===t||void 0===t.file)return i("Missing file");if(o.maxFileSize&&t.file.size>o.maxFileSize)return i("File size too large. Maximum size allowed is "+o.maxFileSize);if(void 0===t.name)return i("Missing attribute: name");o.encodeFilename&&(t.name=(n=t.name,a=n.split("/"),p=[],a.forEach((function(t){for(var e=[],o=encodeURIComponent(t),r=0;r<o.length;r++)e.push(m[o.charCodeAt(r)]||o.charAt(r));p.push(e.join(""))})),p.join("/")));var d=new g(R({started:function(){},uploadInitiated:function(){},progress:function(){},complete:function(){},cancelled:function(){},paused:function(){},resumed:function(){},pausing:function(){},nameChanged:function(){},info:function(){},warn:function(){},error:function(){},beforeSigner:void 0,xAmzHeadersAtInitiate:{},notSignedHeadersAtInitiate:{},xAmzHeadersCommon:null,xAmzHeadersAtUpload:{},xAmzHeadersAtComplete:{}},t,{status:0,priority:0,loadedBytes:0,sizeBytes:t.file.size,eTag:""}),o,r),l=d.id;r.pendingFiles[l]=d,r.queueFile(d),d.deferredCompletion.promise.then((function(){r.fileCleanup(d),s(decodeURIComponent(d.name))}),(function(t){r.fileCleanup(d),i(t)}))}))},y.prototype.cancel=function(t){return void 0===t?this._cancelAll():this._cancelOne(t)},y.prototype._cancelAll=function(){o.d("Canceling all file uploads");var t=[];for(var e in this.pendingFiles)if(this.pendingFiles.hasOwnProperty(e)){var r=this.pendingFiles[e];h.indexOf(r.status)>-1&&t.push(r.stop())}return t.length||t.push(Promise.reject("No files to cancel.")),Promise.all(t)},y.prototype._cancelOne=function(t){var e=[];return this.pendingFiles[t]?e.push(this.pendingFiles[t].stop()):e.push(Promise.reject("File does not exist")),Promise.all(e)},y.prototype.pause=function(t,e){var o=void 0!==(e=e||{}).force&&e.force;return void 0===t?this._pauseAll(o):this._pauseOne(t,o)},y.prototype._pauseAll=function(t){o.d("Pausing all file uploads");var e=[];for(var r in this.pendingFiles)if(this.pendingFiles.hasOwnProperty(r)){var s=this.pendingFiles[r];h.indexOf(s.status)>-1&&this._pause(s,t,e)}return Promise.all(e)},y.prototype._pauseOne=function(t,e){var o=[],r=this.pendingFiles[t];return void 0===r?o.push(Promise.reject("Cannot pause a file that has not been added.")):r.status===n&&o.push(Promise.reject("Cannot pause a file that is already paused.")),o.length||this._pause(r,e,o),Promise.all(o)},y.prototype._pause=function(t,e,o){o.push(t.pause(e)),H(this.filesInProcess,t),H(this.queuedFiles,t)},y.prototype.resume=function(t){return void 0===t?this._resumeAll():this._resumeOne(t)},y.prototype._resumeAll=function(){for(var t in o.d("Resuming all file uploads"),this.pendingFiles)if(this.pendingFiles.hasOwnProperty(t)){var e=this.pendingFiles[t];l.indexOf(e.status)>-1&&this.resumeFile(e)}return Promise.resolve()},y.prototype._resumeOne=function(t){var e=this.pendingFiles[t],o=[];return void 0===e?o.push(Promise.reject("Cannot pause a file that does not exist.")):-1===l.indexOf(e.status)?o.push(Promise.reject("Cannot resume a file that has not been paused.")):this.resumeFile(e),Promise.all(o)},y.prototype.resumeFile=function(t){t.resume(),this.queueFile(t)},y.prototype.forceRetry=function(){},y.prototype.consumeRemainingSlots=function(){var t=this.config.maxConcurrentParts-this.evaporatingCount;if(t)for(var e=0;e<this.filesInProcess.length;e++){var o=this.filesInProcess[e].consumeSlots();if(!(o<0)&&!(t-=o))return}},y.prototype.validateEvaporateOptions=function(){if(this.supported=!("undefined"==typeof File||"undefined"==typeof Promise),!this.supported)return"Evaporate requires support for File and Promise";if(this.config.readableStreams){if("function"!=typeof this.config.readableStreamPartMethod)return"Option readableStreamPartMethod is required when readableStreams is set."}else if("undefined"==typeof Blob||void 0===(Blob.prototype.webkitSlice||Blob.prototype.mozSlice||Blob.prototype.slice))return"Evaporate requires support for Blob [webkitSlice || mozSlice || slice]";if(!this.config.signerUrl&&"function"!=typeof this.config.customAuthMethod)return"Option signerUrl is required unless customAuthMethod is present.";if(!this.config.bucket)return"The AWS 'bucket' option must be present.";if(this.config.computeContentMd5){if(this.supported=void 0!==FileReader.prototype.readAsArrayBuffer,!this.supported)return"The browser's FileReader object does not support readAsArrayBuffer";if("function"!=typeof this.config.cryptoMd5Method)return"Option computeContentMd5 has been set but cryptoMd5Method is not defined.";if("4"===this.config.awsSignatureVersion&&"function"!=typeof this.config.cryptoHexEncodedHash256)return"Option awsSignatureVersion is 4 but cryptoHexEncodedHash256 is not defined."}else if("4"===this.config.awsSignatureVersion)return"Option awsSignatureVersion is 4 but computeContentMd5 is not enabled.";return!0},y.prototype.evaporatingCnt=function(t){this.evaporatingCount=Math.max(0,this.evaporatingCount+t),this.config.evaporateChanged(this,this.evaporatingCount)},g.prototype.con=void 0,g.prototype.evaporate=void 0,g.prototype.localTimeOffset=0,g.prototype.id=void 0,g.prototype.status=0,g.prototype.numParts=-1,g.prototype.fileTotalBytesUploaded=0,g.prototype.partsInProcess=[],g.prototype.partsToUpload=[],g.prototype.s3Parts=[],g.prototype.partsOnS3=[],g.prototype.deferredCompletion=void 0,g.prototype.abortedByUser=!1,g.prototype.progressInterval=void 0,g.prototype.startTime=void 0,g.prototype.loaded=0,g.prototype.totalUploaded=0,g.prototype.updateLoaded=function(t){this.loaded+=t,this.fileTotalBytesUploaded+=t},g.prototype.progessStats=function(){if(0===this.fileTotalBytesUploaded)return{speed:0,readableSpeed:"",loaded:0,totalUploaded:0,remainingSize:this.sizeBytes,secondsLeft:-1,fileSize:this.sizeBytes};this.totalUploaded+=this.loaded;var t=(new Date-this.startTime)/1e3,e=this.totalUploaded/t,o=this.sizeBytes-this.fileTotalBytesUploaded,r={speed:e,readableSpeed:A(e),loaded:this.loaded,totalUploaded:this.fileTotalBytesUploaded,remainingSize:o,secondsLeft:-1,fileSize:this.sizeBytes};return e>0&&(r.secondsLeft=Math.round(o/e)),r},g.prototype.onProgress=function(){-1===[u,n].indexOf(this.status)&&(this.progress(this.fileTotalBytesUploaded/this.sizeBytes,this.progessStats()),this.loaded=0)},g.prototype.startMonitor=function(){clearInterval(this.progressInterval),this.startTime=new Date,this.loaded=0,this.totalUploaded=0,this.onProgress(),this.progressInterval=setInterval(this.onProgress.bind(this),this.con.progressIntervalMS)},g.prototype.stopMonitor=function(){clearInterval(this.progressInterval)},g.prototype.startNextFile=function(t){this.evaporate.startNextFile(t)},g.prototype.evaporatingCnt=function(t){this.evaporate.evaporatingCnt(t)},g.prototype.consumeRemainingSlots=function(){this.evaporate.consumeRemainingSlots()},g.prototype.getRemainingSlots=function(){var t=this.evaporate.evaporatingCount;return!this.partsInProcess.length&&t>0&&(t-=1),this.con.maxConcurrentParts-t},g.prototype.lastPartSatisfied=Promise.resolve("onStart"),g.prototype.start=function(){if(this.status=i,this.startMonitor(),this.started(this.id),this.uploadId)return o.d("resuming FileUpload ",this.id),this.consumeSlots();var t=this.name;this.getUnfinishedFileUpload();var e=this.con.computeContentMd5&&this.con.allowS3ExistenceOptimization&&void 0!==this.firstMd5Digest&&void 0!==this.eTag;if(this.uploadId){if(e)return this.reuseS3Object(t).then(this.deferredCompletion.resolve).catch(this.uploadFileFromScratch.bind(this));this.resumeInterruptedUpload().then(this._uploadComplete.bind(this)).catch(this.uploadFileFromScratch.bind(this))}else this.uploadFileFromScratch("")},g.prototype.uploadFileFromScratch=function(t){if(-1!==h.indexOf(this.status))return o.d(t),this.uploadId=void 0,this.uploadFile(this.name).then(this._uploadComplete.bind(this)).catch(this._abortUpload.bind(this))},g.prototype._uploadComplete=function(){this.completeUpload().then(this.deferredCompletion.resolve)},g.prototype.stop=function(){o.d("stopping FileUpload ",this.id),this.setStatus(a),this.info("Canceling uploads..."),this.abortedByUser=!0;var t=this;return this.abortUpload().then((function(){throw"User aborted the upload"})).catch((function(e){t.deferredCompletion.reject(e)}))},g.prototype.pause=function(t){o.d("pausing FileUpload, force:",!!t,this.id);var e=[];return this.info("Pausing uploads..."),this.status=d,t?this.abortParts(!0):(e=this.partsInProcess.map((function(t){return this.s3Parts[t].awsRequest.awsDeferred.promise}),this),this.pausing()),Promise.all(e).then(function(){this.stopMonitor(),this.status=n,this.startNextFile("pause"),this.paused()}.bind(this))},g.prototype.resume=function(){this.status=0,this.resumed()},g.prototype.done=function(){clearInterval(this.progressInterval),this.startNextFile("file done"),this.partsOnS3=[],this.s3Parts=[]},g.prototype._startCompleteUpload=function(t){return function(){(t?this.completeUpload():Promise.resolve()).then(this.deferredCompletion.resolve.bind(this))}},g.prototype._abortUpload=function(){if(!this.abortedByUser){var t=this;this.abortUpload().then((function(){t.deferredCompletion.reject("File upload aborted due to a part failing to upload")}),this.deferredCompletion.reject.bind(this))}},g.prototype.abortParts=function(t){var e=this;this.partsInProcess.slice(0).forEach((function(o){var r=e.s3Parts[o];r&&(r.awsRequest.abort(),t&&(r.status=0),H(e.partsInProcess,r.partNumber),e.partsToUpload.length&&e.evaporatingCnt(-1))}))},g.prototype.makeParts=function(t){this.numParts=Math.ceil(this.sizeBytes/this.con.partSize)||1;var e=[],o=this;function r(t){H(o.partsToUpload,t.partNumber),H(o.partsInProcess,t.partNumber),o.partsToUpload.length&&o.evaporatingCnt(-1)}function s(t){return function(){r(t),o.partsToUpload.length&&o.consumeRemainingSlots(),o.partsToUpload.length<o.con.maxConcurrentParts&&o.startNextFile("part resolve")}}function i(t){return function(){r(t)}}for(var n=t?1:this.numParts,a=1;a<=n;a++){var p=this.s3Parts[a];if(void 0!==p){if(3===p.status)continue}else p=this.makePart(a,0,this.sizeBytes);p.awsRequest=new q(this,p),p.awsRequest.awsDeferred.promise.then(s(p),i(p)),this.partsToUpload.push(a),e.push(this.s3Parts[a].awsRequest.awsDeferred.promise)}return e},g.prototype.makePart=function(t,e,o){var r={status:e,loadedBytes:0,loadedBytesPrevious:null,isEmpty:0===o,md5_digest:null,partNumber:t};return this.s3Parts[t]=r,r},g.prototype.setStatus=function(t){this.status=t},g.prototype.createUploadFile=function(){this.status!==u&&j(M(this),{awsKey:this.name,bucket:this.con.bucket,uploadId:this.uploadId,fileSize:this.sizeBytes,fileType:this.file.type,lastModifiedDate:O(this.file.lastModified),partSize:this.con.partSize,signParams:this.con.signParams,createdAt:(new Date).toISOString()})},g.prototype.updateUploadFile=function(t){var e=M(this);j(e,R({},z()[e],t))},g.prototype.completeUploadFile=function(t){var e=z(),o=e[M(this)];void 0!==o&&(o.completedAt=(new Date).toISOString(),o.eTag=this.eTag,o.firstMd5Digest=this.firstMd5Digest,e[M(this)]=o,r.setItem("awsUploads",JSON.stringify(e))),this.complete(t,this.name,this.progessStats()),this.setStatus(3),this.onProgress()},g.prototype.removeUploadFile=function(){void 0!==this.file&&function(t){var e=z();delete e[t],r.setItem("awsUploads",JSON.stringify(e))}(M(this))},g.prototype.getUnfinishedFileUpload=function(){var t=z(!0)[M(this)];this.canRetryUpload(t)&&(this.uploadId=t.uploadId,this.name=t.awsKey,this.eTag=t.eTag,this.firstMd5Digest=t.firstMd5Digest,this.signParams=t.signParams)},g.prototype.canRetryUpload=function(t){if(void 0===t)return!1;var o=new Date(t.completedAt||s);return this.con.partSize===t.partSize&&o>e&&this.con.bucket===t.bucket&&(!this.con.onlyRetryForSameFileName||this.name===t.awsKey)},g.prototype.partSuccess=function(t,e){var r=e.part;if(o.d(e.request.step,"ETag:",t),r.isEmpty||'"d41d8cd98f00b204e9800998ecf8427e"'!==t)return r.eTag=t,r.status=3,this.partsOnS3.push(r),!0;r.status=p,e.resetLoadedBytes();var s=["eTag matches MD5 of 0 length blob for part #",e.partNumber,"Retrying part."].join(" ");o.w(s),this.warn(s)},g.prototype.listPartsSuccess=function(t,e){this.info("uploadId",this.uploadId,"is not complete. Fetching parts from part marker",t.partNumberMarker),e=e.replace(/(\r\n|\n|\r)/gm,"");for(var o=/<Part>(.+?)<\/Part\>/g;;){var r=(o.exec(e)||[])[1];if(!r)break;var s=parseInt(_(r,"Size"),10);this.fileTotalBytesUploaded+=s,this.partsOnS3.push({eTag:_(r,"ETag").replace(/&quot;/g,'"'),partNumber:parseInt(_(r,"PartNumber"),10),size:s,LastModified:_(r,"LastModified")})}return"true"===_(e,"IsTruncated")?_(e,"NextPartNumberMarker"):void 0},g.prototype.makePartsfromPartsOnS3=function(){-1!==h.indexOf(this.status)&&(this.nameChanged(this.name),this.partsOnS3.forEach(function(t){var e=this.makePart(t.partNumber,3,t.size);e.eTag=t.eTag,e.loadedBytes=t.size,e.loadedBytesPrevious=t.size,e.finishedUploadingAt=t.LastModified}.bind(this)))},g.prototype.completeUpload=function(){var t=this;return new b(this).send().then((function(e){t.eTag=_(e.responseText,"ETag").replace(/&quot;/g,'"'),t.completeUploadFile(e)}))},g.prototype.getCompletedPayload=function(){var t=[];return t.push("<CompleteMultipartUpload>"),this.s3Parts.forEach((function(e,o){o>0&&["<Part><PartNumber>",o,"</PartNumber><ETag>",e.eTag,"</ETag></Part>"].forEach((function(e){t.push(e)}))})),t.push("</CompleteMultipartUpload>"),t.join("")},g.prototype.consumeSlots=function(){if(0===this.partsToUpload.length)return-1;if(this.partsToUpload.length!==this.partsInProcess.length&&this.status===i){var t=Math.min(this.getRemainingSlots(),this.partsToUpload.length);if(!t)return-1;for(var e=0,o=0;o<this.partsToUpload.length;o++){var r=this.s3Parts[this.partsToUpload[o]];if(r.status!==i&&this.canStartPart(r)){this.partsInProcess.length&&this.partsToUpload.length>1&&this.evaporatingCnt(1),this.partsInProcess.push(r.partNumber);var s=r.awsRequest;if(this.lastPartSatisfied.then(s.delaySend.bind(s)),this.lastPartSatisfied=s.getStartedPromise(),(e+=1)===t)break}}var n=this.partsToUpload.length===this.partsInProcess.length,a=this.getRemainingSlots();return n&&a>0&&this.startNextFile("consume slots"),a}return 0},g.prototype.canStartPart=function(t){return-1===this.partsInProcess.indexOf(t.partNumber)&&!t.awsRequest.errorExceptionStatus()},g.prototype.uploadFile=function(t){this.removeUploadFile();var e=this;return new w(e,t).send().then((function(){return e.uploadInitiated(e.uploadId),e.partsToUpload=[],e.uploadParts().then((function(){}),(function(t){throw t}))}))},g.prototype.uploadParts=function(){if(this.loaded=0,this.totalUploaded=0,-1===h.indexOf(this.status))return Promise.reject("Part uploading stopped because the file was canceled");var t=this.makeParts();return this.setStatus(i),this.startTime=new Date,this.consumeSlots(),Promise.all(t)},g.prototype.abortUpload=function(){return new Promise(function(t,e){void 0!==this.uploadId?new x(this).send().then(t,e):t()}.bind(this)).then(function(){this.setStatus(u),this.cancelled(),this.removeUploadFile()}.bind(this),this.deferredCompletion.reject.bind(this))},g.prototype.resumeInterruptedUpload=function(){return new T(this).send().then(this.uploadParts.bind(this))},g.prototype.reuseS3Object=function(t){var e=this;this.makeParts(1),this.partsToUpload=[];var r=this.s3Parts[1];function s(o){throw e.name=t,o}return r.awsRequest.getPartMd5Digest().then((function(){if(e.firstMd5Digest===r.md5_digest)return new U(e,t).send().then((function(t){o.d("headObject found matching object on S3."),e.completeUploadFile(t),e.nameChanged(e.name)})).catch(s);s(e.con.allowS3ExistenceOptimization?"File's first part MD5 digest does not match what was stored.":"allowS3ExistenceOptimization is not enabled.")}))},v.prototype.fileUpload=void 0,v.prototype.con=void 0,v.prototype.awsUrl=void 0,v.prototype.awsHost=void 0,v.prototype.authorize=function(){},v.prototype.localTimeOffset=0,v.prototype.awsDeferred=void 0,v.prototype.started=void 0,v.prototype.getPath=function(){return"/"+this.fileUpload.name},v.prototype.updateRequest=function(t){this.request=t;var e=function(t,e){var o=t.con;function r(t){this.request=t}function s(t){r.call(this,t)}function i(t){this._cr=void 0,r.call(this,t)}return r.prototype.request={},r.prototype.error=function(){},r.prototype.authorizationString=function(){},r.prototype.stringToSign=function(){},r.prototype.canonicalRequest=function(){},r.prototype.setHeaders=function(){},r.prototype.datetime=function(t){return new Date((new Date).getTime()+t)},r.prototype.dateString=function(t){return this.datetime(t).toISOString().slice(0,19).replace(/-|:/g,"")+"Z"},s.prototype=Object.create(r.prototype),s.prototype.constructor=s,s.prototype.authorizationString=function(){return["AWS ",o.aws_key,":",this.request.auth].join("")},s.prototype.stringToSign=function(){var r,s="",i=[];for(var n in this.request.x_amz_headers)this.request.x_amz_headers.hasOwnProperty(n)&&i.push(n);return i.sort(),i.forEach(function(t){s+=t+":"+this.request.x_amz_headers[t]+"\n"}.bind(this)),r=this.request.method+"\n"+(this.request.md5_digest||"")+"\n"+(this.request.contentType||"")+"\n\n"+s+(o.cloudfront?"/":"")+t.getPath()+this.request.path,e.d("V2 stringToSign:",r),r},s.prototype.dateString=function(t){return this.datetime(t).toUTCString()},s.prototype.getPayload=function(){return Promise.resolve()},i.prototype=Object.create(r.prototype),i.prototype.constructor=i,i.prototype._cr=void 0,i.prototype.payload=null,i.prototype.error=function(){this._cr=void 0},i.prototype.getPayload=function(){return t.getPayload().then(function(t){this.payload=t}.bind(this))},i.prototype.authorizationString=function(){var t=[],e=this.credentialString(),r=this.canonicalHeaders();return t.push(["AWS4-HMAC-SHA256 Credential=",o.aws_key,"/",e].join("")),t.push("SignedHeaders="+r.signedHeaders),t.push("Signature="+this.request.auth),t.join(", ")},i.prototype.stringToSign=function(){var t=[];t.push("AWS4-HMAC-SHA256"),t.push(this.request.dateString),t.push(this.credentialString()),t.push(o.cryptoHexEncodedHash256(this.canonicalRequest()));var r=t.join("\n");return e.d("V4 stringToSign:",r),r},i.prototype.credentialString=function(){var t=[];return t.push(this.request.dateString.slice(0,8)),t.push(o.awsRegion),t.push("s3"),t.push("aws4_request"),t.join("/")},i.prototype.canonicalQueryString=function(){var e,o,r=t.request.query_string||"",s=C([t.awsUrl,this.request.path,r].join("")).search,i=s.length?s.split("&"):[],n=[];for(o=0;o<i.length;o++)e=i[o].split("="),n.push({name:encodeURIComponent(e[0]),value:e.length>1?encodeURIComponent(e[1]):null});var a=n.sort((function(t,e){return t.name<e.name?-1:t.name>e.name?1:0})),p=[];for(o=0;o<a.length;o++)e=a[o].value?[a[o].name,a[o].value].join("="):a[o].name+"=",p.push(e);return p.join("&")},i.prototype.getPayloadSha256Content=function(){var t=this.request.contentSha256||o.cryptoHexEncodedHash256(this.payload||"");return e.d(this.request.step,"getPayloadSha256Content:",t),t},i.prototype.canonicalHeaders=function(){var e,o=[],r=[];function s(t,e){var s=t.toLowerCase();r.push(s),o[s]=e.replace(/\s+/g," ")}this.request.md5_digest&&s("Content-Md5",this.request.md5_digest),s("Host",t.awsHost),this.request.contentType&&s("Content-Type",this.request.contentType||"");var i=this.request.x_amz_headers||{};for(var n in i)i.hasOwnProperty(n)&&s(n,i[n]);var a=r.sort((function(t,e){return t<e?-1:t>e?1:0})),p=[],u=[],d=this.request.not_signed_headers||[],l=[];for(e=0;e<d.length;e++)u.push(d[e].toLowerCase());for(e=0;e<a.length;e++){var h=a[e];p.push([h,o[h]].join(":")),-1===u.indexOf(h)&&l.push(h)}return{canonicalHeaders:p.join("\n"),signedHeaders:l.join(";")}},i.prototype.canonicalRequest=function(){if(void 0!==this._cr)return this._cr;var o=[];o.push(this.request.method),o.push(C([t.awsUrl,t.getPath(),this.request.path].join("")).pathname),o.push(this.canonicalQueryString()||"");var r=this.canonicalHeaders();return o.push(r.canonicalHeaders+"\n"),o.push(r.signedHeaders),o.push(this.getPayloadSha256Content()),this._cr=o.join("\n"),e.d(this.request.step,"V4 CanonicalRequest:",this._cr),this._cr},i.prototype.setHeaders=function(t){t.setRequestHeader("x-amz-content-sha256",this.getPayloadSha256Content())},"4"===o.awsSignatureVersion?i:s}(this,o);this.signer=new e(t)},v.prototype.success=function(){this.awsDeferred.resolve(this.currentXhr)},v.prototype.backOffWait=function(){return 1===this.attempts?0:1e3*Math.min(this.con.maxRetryBackoffSecs,Math.pow(this.con.retryBackoffPower,this.attempts-2))},v.prototype.error=function(t){if(!this.errorExceptionStatus()&&(this.signer.error(),o.d(this.request.step,"error:",this.fileUpload.id,t),void 0===this.errorHandler(t))){this.fileUpload.warn("Error in ",this.request.step,t),this.fileUpload.setStatus(p);var e=this,r=this.backOffWait();this.attempts+=1,setTimeout((function(){e.errorExceptionStatus()||e.trySend()}),r)}},v.prototype.errorHandler=function(){},v.prototype.errorExceptionStatus=function(){return!1},v.prototype.getPayload=function(){return Promise.resolve(null)},v.prototype.success_status=function(t){return t.status>=200&&t.status<=299||this.request.success404&&404===t.status},v.prototype.stringToSign=function(){return encodeURIComponent(this.signer.stringToSign())},v.prototype.canonicalRequest=function(){return this.signer.canonicalRequest()},v.prototype.signResponse=function(t,e,o){var r=this;return new Promise((function(s){if("function"==typeof r.con.signResponseHandler)return r.con.signResponseHandler(t,e,o).then(s);s(t)}))},v.prototype.sendRequestToAWS=function(){var t=this;return new Promise((function(e,o){var r=new XMLHttpRequest;t.currentXhr=r;var s=[t.awsUrl,t.getPath(),t.request.path].join(""),i={};for(var n in t.request.query_string&&(s+=t.request.query_string),R(i,t.request.not_signed_headers),R(i,t.request.x_amz_headers),r.onreadystatechange=function(){if(4===r.readyState)if(t.success_status(r))t.request.response_match&&void 0===r.response.match(new RegExp(t.request.response_match))?o("AWS response does not match set pattern: "+t.request.response_match):e();else{var s=r.responseText?I(r):" ";s+="status:"+r.status,o(s)}},r.open(t.request.method,s),r.setRequestHeader("Authorization",t.signer.authorizationString()),i)i.hasOwnProperty(n)&&r.setRequestHeader(n,i[n]);t.signer.setHeaders(r),t.request.contentType&&r.setRequestHeader("Content-Type",t.request.contentType),t.request.md5_digest&&r.setRequestHeader("Content-MD5",t.request.md5_digest),r.onerror=function(t){var e=t.responseText?I(t):"transport error";o(e)},"function"==typeof t.request.onProgress&&(r.upload.onprogress=t.request.onProgress),t.getPayload().then(r.send.bind(r),o),setTimeout((function(){t.started.resolve("request sent "+t.request.step)}),20),t.signer.payload=null,t.payloadPromise=void 0}))},v.prototype.authorize=function(){return this.request.dateString=this.signer.dateString(this.localTimeOffset),this.request.x_amz_headers=R(this.request.x_amz_headers,{"x-amz-date":this.request.dateString}),this.signer.getPayload().then(function(){return function(t){var e=t.fileUpload,o=e.con,r=t.request;function s(){this.request=r}function i(){s.call(this)}return s.prototype=Object.create(s.prototype),s.prototype.request={},s.makeSignParamsObject=function(t){var e={};for(var o in t)t.hasOwnProperty(o)&&("function"==typeof t[o]?e[o]=t[o]():e[o]=t[o]);return e},s.prototype.authorize=function(){return new Promise((function(i,n){var a=new XMLHttpRequest;t.currentXhr=a;var p=t.stringToSign(),u=[o.signerUrl,"?to_sign=",p,"&datetime=",r.dateString];o.sendCanonicalRequestToSignerUrl&&(u.push("&canonical_request="),u.push(encodeURIComponent(t.canonicalRequest()))),u=u.join("");var d=s.makeSignParamsObject(e.signParams);for(var l in d)d.hasOwnProperty(l)&&(u+="&"+encodeURIComponent(l)+"="+encodeURIComponent(d[l]));o.xhrWithCredentials&&(a.withCredentials=!0),a.onreadystatechange=function(){if(4===a.readyState)if(200===a.status)t.signResponse(a.response,p,r.dateString).then(i);else{if([401,403].indexOf(a.status)>-1){var o="status:"+a.status;return e.deferredCompletion.reject("Permission denied "+o),n(o)}n("Signature fetch returned status: "+a.status)}},a.onerror=function(t){n("authorizedSend transport error: "+t.responseText)},a.open("GET",u);var h=s.makeSignParamsObject(o.signHeaders);for(var c in h)h.hasOwnProperty(c)&&a.setRequestHeader(c,h[c]);"function"==typeof e.beforeSigner&&e.beforeSigner(a,u),a.send()}))},i.prototype=Object.create(s.prototype),i.prototype.authorize=function(){return o.customAuthMethod(s.makeSignParamsObject(e.signParams),s.makeSignParamsObject(o.signHeaders),t.stringToSign(),r.dateString,t.canonicalRequest()).catch((function(t){throw e.deferredCompletion.reject(t),t}))},"function"==typeof o.customAuthMethod?new i:new s}(this).authorize()}.bind(this))},v.prototype.authorizationSuccess=function(t){o.d(this.request.step,"signature:",t),this.request.auth=t},v.prototype.trySend=function(){var t=this;return this.authorize().then((function(e){t.authorizationSuccess(e),t.fileUpload.status!==u&&t.sendRequestToAWS().then(t.success.bind(t),t.error.bind(t))}),t.error.bind(t))},v.prototype.send=function(){return this.trySend(),this.awsDeferred.promise},S.prototype=Object.create(v.prototype),S.prototype.constructor=S,S.prototype.errorExceptionStatus=function(){return[u,a].indexOf(this.fileUpload.status)>-1},P.prototype=Object.create(S.prototype),P.prototype.constructor=P,P.prototype.maxRetries=1,P.prototype.errorHandler=function(t){if(this.attempts>this.maxRetries){var e=["MaxRetries exceeded. Will re-upload file id ",this.fileUpload.id,", ",t].join("");return o.w(e),this.awsDeferred.reject(e),!0}},P.prototype.rejectedSuccess=function(){var t=Array.prototype.slice.call(arguments,1).join("");return this.awsDeferred.reject(t),!1},w.prototype=Object.create(S.prototype),w.prototype.constructor=w,w.prototype.success=function(){var t=this.currentXhr.response.match(new RegExp(this.request.response_match));this.fileUpload.uploadId=t[1],this.fileUpload.awsKey=this.awsKey,o.d("InitiateMultipartUpload ID is",this.fileUpload.uploadId),this.fileUpload.createUploadFile(),this.awsDeferred.resolve(this.currentXhr)},b.prototype=Object.create(S.prototype),b.prototype.constructor=b,b.prototype.getPayload=function(){return Promise.resolve(this.fileUpload.getCompletedPayload())},U.prototype=Object.create(P.prototype),U.prototype.constructor=U,U.prototype.awsKey=void 0,U.prototype.success=function(){(this.currentXhr.getResponseHeader("Etag")===this.fileUpload.eTag||this.rejectedSuccess("uploadId ",this.fileUpload.id," found on S3 but the Etag doesn't match."))&&this.awsDeferred.resolve(this.currentXhr)},T.prototype=Object.create(P.prototype),T.prototype.constructor=T,T.prototype.awsKey=void 0,T.prototype.partNumberMarker=0,T.prototype.setupRequest=function(t){var e=["setupRequest() for uploadId:",this.fileUpload.uploadId,"for part marker:",t].join(" ");o.d(e),this.fileUpload.info(e),this.awsKey=this.fileUpload.name,this.partNumberMarker=t;var r={method:"GET",path:["?uploadId=",this.fileUpload.uploadId].join(""),query_string:"&part-number-marker="+t,x_amz_headers:this.fileUpload.xAmzHeadersCommon,step:"get upload parts",success404:!0};return this.request=r,r},T.prototype.success=function(){if(404!==this.currentXhr.status){var t=this.fileUpload.listPartsSuccess(this,this.currentXhr.responseText);if(t){var e=this.setupRequest(t);this.updateRequest(e),this.trySend()}else this.fileUpload.makePartsfromPartsOnS3(),this.awsDeferred.resolve(this.currentXhr)}else this.rejectedSuccess("uploadId ",this.fileUpload.id," not found on S3.")&&this.awsDeferred.resolve(this.currentXhr)},q.prototype=Object.create(v.prototype),q.prototype.constructor=q,q.prototype.part=1,q.prototype.payloadPromise=void 0,q.prototype.start=0,q.prototype.end=0,q.prototype.partNumber=void 0,q.prototype.getPartMd5Digest=function(){var t=this,e=this.part;return new Promise((function(o,r){t.con.computeContentMd5&&!e.md5_digest?t.getPayload().then((function(e){var r=t.con.cryptoMd5Method(e);1===t.partNumber&&t.con.computeContentMd5&&void 0===t.fileUpload.firstMd5Digest&&(t.fileUpload.firstMd5Digest=r,t.fileUpload.updateUploadFile({firstMd5Digest:r})),o(r)}),r):o(e.md5_digest)})).then((function(e){e&&(o.d(t.request.step,"MD5 digest:",e),t.request.md5_digest=e,t.part.md5_digest=e)}))},q.prototype.sendRequestToAWS=function(){return this.stalledInterval=setInterval(this.stalledPartMonitor(),c),this.stalledPartMonitor(),v.prototype.sendRequestToAWS.call(this)},q.prototype.send=function(){if(3!==this.part.status&&-1===[u,n,a].indexOf(this.fileUpload.status)){o.d("uploadPart #",this.partNumber,1===this.attempts?"submitting":"retrying"),this.part.status=i,this.attempts+=1,this.part.loadedBytesPrevious=null;var t=this;return this.getPartMd5Digest().then((function(){o.d("Sending",t.request.step),v.prototype.send.call(t)}))}},q.prototype.success=function(){clearInterval(this.stalledInterval);var t=this.currentXhr.getResponseHeader("ETag");this.currentXhr=null,this.fileUpload.partSuccess(t,this)&&this.awsDeferred.resolve(this.currentXhr)},q.prototype.onProgress=function(t){if(t.loaded>0){var e=t.loaded-this.part.loadedBytes;e&&(this.part.loadedBytes=t.loaded,this.fileUpload.updateLoaded(e))}},q.prototype.stalledPartMonitor=function(){var t=this.part.loadedBytes,e=this;return function(){clearInterval(e.stalledInterval),-1===[i,p,d,n].indexOf(e.fileUpload.status)&&e.part.status!==u&&e.part.loadedBytes<this.size&&(t===e.part.loadedBytes?(o.w("Part stalled. Will abort and retry:",e.partNumber,decodeURIComponent(e.fileUpload.name)),e.abort(),e.errorExceptionStatus()||e.delaySend()):e.stalledInterval=setInterval(e.stalledPartMonitor(),c))}},q.prototype.resetLoadedBytes=function(){this.fileUpload.updateLoaded(-this.part.loadedBytes),this.part.loadedBytes=0,this.fileUpload.onProgress()},q.prototype.errorExceptionStatus=function(){return[a,u,n,d].indexOf(this.fileUpload.status)>-1},q.prototype.delaySend=function(){var t=this.backOffWait();this.attempts+=1,setTimeout(this.send.bind(this),t)},q.prototype.errorHandler=function(t){if(clearInterval(this.stalledInterval),t.match(/status:404/)){var e="404 error on part PUT. The part and the file will abort. "+t;return o.w(e),this.fileUpload.error(e),this.part.status=u,this.awsDeferred.reject(e),!0}return this.resetLoadedBytes(),this.part.status=p,this.errorExceptionStatus()||this.delaySend(),!0},q.prototype.abort=function(){this.currentXhr&&this.currentXhr.abort(),this.resetLoadedBytes(),this.attempts=1},q.size=0,q.prototype.streamToArrayBuffer=function(t){return new Promise(function(e,o){if(!t.readable)return e([]);var r=new Uint8Array(Math.min(this.con.partSize,this.end-this.start)),s=0;function i(t){1!==t.byteLength&&(r.set(t,s),s+=t.byteLength)}function n(t){t?o(t):e(r),p()}function a(){e(r),p()}function p(){r=null,t.removeListener("data",i),t.removeListener("end",n),t.removeListener("error",n),t.removeListener("close",a)}t.on("data",i),t.on("end",n),t.on("error",n),t.on("close",a)}.bind(this))},q.prototype.getPayload=function(){return void 0===this.payloadPromise&&(this.payloadPromise=this.con.readableStreams?this.payloadFromStream():this.payloadFromBlob()),this.payloadPromise},q.prototype.payloadFromStream=function(){var t=this.con.readableStreamPartMethod(this.fileUpload.file,this.start,this.end-1);return new Promise(function(e,o){this.streamToArrayBuffer(t).then(function(t){e(t)}.bind(this),o)}.bind(this))},q.prototype.payloadFromBlob=function(){var t=this.fileUpload.file,e=t[t.slice?"slice":t.mozSlice?"mozSlice":"webkitSlice"](this.start,this.end);return this.con.computeContentMd5?new Promise((function(t){var o=new FileReader;o.onloadend=function(){var e=this.result&&void 0!==this.result.buffer?new Uint8Array(this.result.buffer):this.result;t(e)},o.readAsArrayBuffer(e)})):Promise.resolve(e)},q.prototype.stalledInterval=-1,q.prototype.getStartedPromise=function(){return this.started.promise},x.prototype=Object.create(v.prototype),x.prototype.constructor=x,x.prototype.maxRetries=1,x.prototype.success=function(){this.fileUpload.setStatus(u),this.awsDeferred.resolve(this.currentXhr)},x.prototype.errorHandler=function(t){if(this.attempts>this.maxRetries){var e="Error aborting upload, Exceeded retries deleting the file upload: "+t;return o.w(e),this.fileUpload.error(e),this.awsDeferred.reject(e),!0}},E.prototype.supported=!1,E.prototype.cacheStore=void 0,E.prototype.getItem=function(t){if(this.cacheStore)return this.cacheStore[t]},E.prototype.setItem=function(t,e){this.cacheStore&&(this.cacheStore[t]=e)},E.prototype.removeItem=function(t){if(this.cacheStore)return delete this.cacheStore[t]},E.supported=function(){var t=!1;if("undefined"==typeof window)return t;if(!("localStorage"in window))return t;try{var e="___test";localStorage[e]="OK";var o=localStorage[e];return delete localStorage[e],"OK"===o}catch(e){return t}},o={d:function(){},w:function(){},e:function(){}},t?t=y:"undefined"!=typeof window&&(window.Evaporate=y)}()}();